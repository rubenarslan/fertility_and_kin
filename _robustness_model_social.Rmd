---
title: "_robustness_model_social"
author: "Julie"
date: "21 November 2018"
output: html_document
---
#### Model summary {.tabset}

##### Basic model
```{r echo=F, results='hide',message=F,warning=F, error=F}
library(knitr); library(brms)
```

```{r}
sjPlot::tab_model(model, transform = NULL, show.hdi50 = FALSE, bpe = "mean", prefix.labels	= "varname")
summary(model)
stanplot(model)

marginal_effects(model)
# bn <- xfun::sans_ext(basename(model$file))
```


##### With full random slopes


```{r}
add_mod_formula = update.formula(
    formula(model),
    new = as.formula(. ~ . - (1 + fertile_fab | short) + (1 + premenstrual_phase_fab + menstruation + fertile_fab | short ))) # reorder so that the triptych looks nice

 full_random_slopes = update(model, iter = 6000, warmup = 4000, cores = 4, formula = add_mod_formula, newdata = diary_social, file= paste0("brms_fits/", bn, "robustness_random_slope4"))


sjPlot::tab_model(full_random_slopes, transform = NULL, show.hdi50 = FALSE, bpe = "mean", prefix.labels	= "varname")
summary(model)
stanplot(full_random_slopes)



marginal_effects(full_random_slopes)
# brmstools::spaghetti(full_random_slopes)
```


##### Exclude women trying to get pregnant


```{r}
pregnant_trying = update(model, cores = 4, newdata = diary_social %>% filter(pregnant_trying < 4), file=paste0("brms_fits/", bn, "pregnant_trying"))

sjPlot::tab_model(pregnant_trying, transform = NULL, show.hdi50 = FALSE, bpe = "mean", prefix.labels	= "varname")
summary(pregnant_trying)
stanplot(pregnant_trying)

marginal_effects(pregnant_trying)
```

##### Moderation by weekend
```{r}
add_mod_formula = update.formula(
    update.formula(formula(model), new = . ~ . - hormonal_contraception * fertile_fab), 
    new = as.formula(. ~ . + weekend * hormonal_contraception * fertile_fab)) # reorder so that the triptych looks nice
weekend = update(model, cores = 4,  newdata = diary_social, formula = add_mod_formula, file=paste0("brms_fits/", bn, "pregnant_robustness_weekend"))

sjPlot::tab_model(weekend, transform = NULL, show.hdi50 = FALSE, bpe = "mean", prefix.labels	= "varname")
summary(weekend)
stanplot(weekend)

marginal_effects(weekend)
```


##### Moderation by age group


```{r}
add_mod_formula = update.formula(
    update.formula(formula(model), new = . ~ . - hormonal_contraception * fertile_fab), 
    new = as.formula(. ~ . + age_group * hormonal_contraception * fertile_fab)) # reorder so that the triptych looks nice
age_mod = update(model, cores = 4, newdata = diary_social, formula = add_mod_formula, file=paste0("brms_fits/", bn, "pregnant_robustness_age_mod2"))

sjPlot::tab_model(age_mod, transform = NULL, show.hdi50 = FALSE, bpe = "mean", prefix.labels	= "varname")

summary(age_mod)
stanplot(age_mod)
marginal_effects(age_mod)
```

##### Excluding women who used psychopharmacological, hormonal, or antibiotic medication

```{r}
# crosstabs(~ medication_psychopharmacological + medication_hormonal + medication_antibiotics, data = all_surveys)

diary_social <- diary_social %>% ungroup() %>% 
  mutate(medication_psychopharmacological = if_else(is.na(medication_psychopharmacological), 0, medication_psychopharmacological),
         medication_hormonal = if_else(is.na(medication_hormonal), 0, medication_hormonal),
         medication_antibiotics = if_else(is.na(medication_antibiotics), 0, medication_antibiotics))

exclude_meds = update(model, cores = 4, newdata= diary_social %>% filter(medication_psychopharmacological == 0, medication_hormonal == 0, medication_antibiotics == 0), file=paste0("brms_fits/", bn, "_meds"))

sjPlot::tab_model(exclude_meds, transform = NULL, show.hdi50 = FALSE, bpe = "mean", prefix.labels	= "varname")
summary(exclude_meds)
stanplot(exclude_meds)
marginal_effects(exclude_meds)
```

##### Excluding hypothesis guessers

```{r}
hyp_guess = update(model, cores = 4,newdata = diary_social %>% filter(hypothesis_guess_topic == "no_guess"), file=paste0("brms_fits/", bn, "_hyp_guess2"))

sjPlot::tab_model(hyp_guess, transform = NULL, show.hdi50 = FALSE, bpe = "mean", prefix.labels	= "varname")
summary(hyp_guess)
stanplot(hyp_guess)
marginal_effects(hyp_guess)
```

##### Excluding women with cycles longer than 40 days

```{r}
avg_cycles = update(model,  cores = 4, newdata = diary_social %>% filter(cycle_length <= 40, cycle_length >= 20), file=paste0("brms_fits/", bn, "_avg_cycles"))

sjPlot::tab_model(avg_cycles, transform = NULL, show.hdi50 = FALSE, bpe = "mean", prefix.labels	= "varname")
summary(avg_cycles)
stanplot(avg_cycles)
marginal_effects(avg_cycles)
```


##### Excluding women using awareness-based methods


```{r}
crosstabs(~ contraception_app + contraception_approach, all_surveys %>% filter(hetero_relationship == 0))

unaware = update(model, cores = 4,newdata = diary_social %>% filter(contraception_approach != "awareness", contraception_app == 0), file=paste0("brms_fits/", bn, "unaware"))

sjPlot::tab_model(unaware, transform = NULL, show.hdi50 = FALSE, bpe = "mean", prefix.labels	= "varname")
summary(unaware)
stanplot(unaware)
marginal_effects(unaware)
```


##### Don't adjust for menstruation


```{r}
dont_adjust = update.formula(formula(model), new = . ~ . - menstruation - premenstrual_phase_fab)
no_mens = update(model, cores = 4, newdata = diary_social, formula = dont_adjust, file=paste0("brms_fits/", bn, "no_mens"))

sjPlot::tab_model(no_mens, transform = NULL, show.hdi50 = FALSE, bpe = "mean", prefix.labels	= "varname")

summary(no_mens)
stanplot(no_mens)

marginal_effects(no_mens)
```


##### Using forward counting


```{r}
forward_counted = update(model, cores = 4,newdata = diary_social %>% mutate(fertile_fab = prc_stirn_b_forward_counted), file=paste0("brms_fits/", bn, "forward_counted"))

sjPlot::tab_model(forward_counted, transform = NULL, show.hdi50 = FALSE, bpe = "mean", prefix.labels	= "varname")
summary(forward_counted)
stanplot(forward_counted)
marginal_effects(forward_counted)
```


##### Without random slopes

```{r}
no_varying_slope = update(model, formula = . ~ . - (1 + fertile_fab | short) + (1|short), cores = 4, file = paste0("brms_fits/", bn, "no_varying_slope"))

sjPlot::tab_model(no_varying_slope, transform = NULL, show.hdi50 = FALSE, bpe = "mean", prefix.labels	= "varname")
summary(no_varying_slope)
stanplot(no_varying_slope)
marginal_effects(no_varying_slope)
```

##### Only women with outcome variability

```{r}
with_outcome_var = update(model, cores = 4, newdata = diary_social %>% group_by(session) %>% filter(sd(person_is_related_man, na.rm = T) > 0), file = paste0("brms_fits/", bn, "with_outcome_var"))

sjPlot::tab_model(with_outcome_var, transform = NULL, show.hdi50 = FALSE, bpe = "mean", prefix.labels	= "varname")
summary(with_outcome_var)
stanplot(with_outcome_var)
marginal_effects(with_outcome_var)
```
